<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript | Range&#39;s Documents.</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Meet more than the eyes.">
    <link rel="preload" href="/assets/css/0.styles.34d67128.css" as="style"><link rel="preload" href="/assets/js/app.76b04930.js" as="script"><link rel="preload" href="/assets/js/2.f4607b1e.js" as="script"><link rel="preload" href="/assets/js/12.cb6c9e06.js" as="script"><link rel="prefetch" href="/assets/js/10.f1a63439.js"><link rel="prefetch" href="/assets/js/11.ee698251.js"><link rel="prefetch" href="/assets/js/13.70cff9bc.js"><link rel="prefetch" href="/assets/js/14.4a79e630.js"><link rel="prefetch" href="/assets/js/15.67d11263.js"><link rel="prefetch" href="/assets/js/16.72f4a548.js"><link rel="prefetch" href="/assets/js/17.0268da32.js"><link rel="prefetch" href="/assets/js/18.cb942bd1.js"><link rel="prefetch" href="/assets/js/19.1c1462cc.js"><link rel="prefetch" href="/assets/js/20.633a6928.js"><link rel="prefetch" href="/assets/js/21.0ed654e1.js"><link rel="prefetch" href="/assets/js/22.dddc26a9.js"><link rel="prefetch" href="/assets/js/3.aa48cf35.js"><link rel="prefetch" href="/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/assets/js/5.f8be39f3.js"><link rel="prefetch" href="/assets/js/6.0ba3b038.js"><link rel="prefetch" href="/assets/js/7.38e656bc.js"><link rel="prefetch" href="/assets/js/8.830cb397.js"><link rel="prefetch" href="/assets/js/9.2fac5c3a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34d67128.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.png" alt="Range's Documents." class="logo"> <span class="site-name can-hide">Range's Documents.</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Documents
</a></div><div class="nav-item"><a href="https://github.com/Range0122" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  Documents
</a></div><div class="nav-item"><a href="https://github.com/Range0122" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/os/" class="sidebar-link">Operating System</a></li><li><a href="/network/" class="sidebar-link">Computer Network</a></li><li><a href="/leetcode/" class="sidebar-link">LeetCode</a></li><li><a href="/browser/" class="sidebar-link">Browser</a></li><li><a href="/html/" class="sidebar-link">HTML</a></li><li><a href="/css/" class="sidebar-link">CSS</a></li><li><a href="/javascript/" aria-current="page" class="active sidebar-link">JavaScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_1-var-let-const-和变量提升" class="sidebar-link">1. var &amp; let &amp; const 和变量提升</a></li><li class="sidebar-sub-header"><a href="/javascript/#_2-八大数据类型" class="sidebar-link">2. 八大数据类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_2-1-概念" class="sidebar-link">2.1 概念</a></li><li class="sidebar-sub-header"><a href="/javascript/#_2-2-为什么引用数据类型会变化呢？" class="sidebar-link">2.2 为什么引用数据类型会变化呢？</a></li><li class="sidebar-sub-header"><a href="/javascript/#_2-3-null和undefined的区别" class="sidebar-link">2.3 null和undefined的区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_3-闭包" class="sidebar-link">3. 闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_3-1-产生闭包：" class="sidebar-link">3.1 产生闭包：</a></li><li class="sidebar-sub-header"><a href="/javascript/#_3-2-概念" class="sidebar-link">3.2 概念</a></li><li class="sidebar-sub-header"><a href="/javascript/#_3-3-应用场景" class="sidebar-link">3.3 应用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_4-settimeout-setinterval" class="sidebar-link">4. setTimeout &amp; setInterval</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_4-1-chrome实现settimeout" class="sidebar-link">4.1 Chrome实现setTimeout</a></li><li class="sidebar-sub-header"><a href="/javascript/#_4-2-settimeout的注意点" class="sidebar-link">4.2 setTimeout的注意点</a></li><li class="sidebar-sub-header"><a href="/javascript/#_4-3-setinterval" class="sidebar-link">4.3 setInterval</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_5-promise" class="sidebar-link">5. promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_5-1-概念" class="sidebar-link">5.1 概念</a></li><li class="sidebar-sub-header"><a href="/javascript/#_5-2-一些特性和-promise-a" class="sidebar-link">5.2 一些特性和 Promise/A+</a></li><li class="sidebar-sub-header"><a href="/javascript/#_5-3-promise-的返回值" class="sidebar-link">5.3 promise 的返回值</a></li><li class="sidebar-sub-header"><a href="/javascript/#_5-4-api" class="sidebar-link">5.4 API</a></li><li class="sidebar-sub-header"><a href="/javascript/#_5-4-promise-执行时序总结" class="sidebar-link">5.4 promise 执行时序总结</a></li><li class="sidebar-sub-header"><a href="/javascript/#_5-5-实现一个简单的-promise" class="sidebar-link">5.5 实现一个简单的 promise</a></li><li class="sidebar-sub-header"><a href="/javascript/#_5-6-手写实现串行异步任务的思路" class="sidebar-link">5.6 手写实现串行异步任务的思路</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_6-对象" class="sidebar-link">6.对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_6-1-属性类型" class="sidebar-link">6.1 属性类型</a></li><li class="sidebar-sub-header"><a href="/javascript/#_6-2-创建对象" class="sidebar-link">6.2 创建对象</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_7-继承" class="sidebar-link">7. 继承</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_7-1-原型" class="sidebar-link">7.1 原型</a></li><li class="sidebar-sub-header"><a href="/javascript/#_7-2-继承" class="sidebar-link">7.2 继承</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_8-dom事件流" class="sidebar-link">8. DOM事件流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_8-1-事件流" class="sidebar-link">8.1 事件流</a></li><li class="sidebar-sub-header"><a href="/javascript/#_8-2-事件处理程序" class="sidebar-link">8.2 事件处理程序</a></li><li class="sidebar-sub-header"><a href="/javascript/#_8-3-停止传播" class="sidebar-link">8.3 停止传播</a></li><li class="sidebar-sub-header"><a href="/javascript/#_8-4-事件委托（事件代理）" class="sidebar-link">8.4 事件委托（事件代理）</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_9-error" class="sidebar-link">9. Error</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_9-1-error的标准属性" class="sidebar-link">9.1 Error的标准属性</a></li><li class="sidebar-sub-header"><a href="/javascript/#_9-2-error的种类" class="sidebar-link">9.2 Error的种类</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_10-es6-新特性" class="sidebar-link">10. ES6 新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_10-1-let-const" class="sidebar-link">10.1 let &amp; const</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-2-模板字符串" class="sidebar-link">10.2 模板字符串</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-3-箭头函数" class="sidebar-link">10.3 箭头函数</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-4-新数据类型" class="sidebar-link">10.4 新数据类型</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-5-set-和-map" class="sidebar-link">10.5 Set 和 Map</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-6-for-of" class="sidebar-link">10.6 for of</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-7-promise" class="sidebar-link">10.7 Promise</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-8-class" class="sidebar-link">10.8 Class</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-9-拓展运算符" class="sidebar-link">10.9 拓展运算符</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-10-解构赋值" class="sidebar-link">10.10 解构赋值</a></li><li class="sidebar-sub-header"><a href="/javascript/#_10-11-对象属性简写（属性增强）" class="sidebar-link">10.11 对象属性简写（属性增强）</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_11-async-await" class="sidebar-link">11. Async / Await</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_11-1-基本语法" class="sidebar-link">11.1 基本语法</a></li><li class="sidebar-sub-header"><a href="/javascript/#_11-2-错误处理" class="sidebar-link">11.2 错误处理</a></li><li class="sidebar-sub-header"><a href="/javascript/#_11-3-在项目中使用async" class="sidebar-link">11.3 在项目中使用async</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_12-fetch" class="sidebar-link">12. fetch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_12-1-概念" class="sidebar-link">12.1 概念</a></li><li class="sidebar-sub-header"><a href="/javascript/#_12-2-特点" class="sidebar-link">12.2 特点</a></li><li class="sidebar-sub-header"><a href="/javascript/#_12-3-举例" class="sidebar-link">12.3 举例</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_13-pwa（progressive-web-apps，渐进式网络应用程序）" class="sidebar-link">13. PWA（Progressive Web Apps，渐进式网络应用程序）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_13-1-概念" class="sidebar-link">13.1 概念</a></li><li class="sidebar-sub-header"><a href="/javascript/#_13-2-service-worker" class="sidebar-link">13.2 service worker</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_14-防抖和节流" class="sidebar-link">14. 防抖和节流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_14-1-防抖" class="sidebar-link">14.1 防抖</a></li><li class="sidebar-sub-header"><a href="/javascript/#_14-2-节流" class="sidebar-link">14.2 节流</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_15-js阻塞dom的解析" class="sidebar-link">15. JS阻塞DOM的解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_15-1-ui渲染线程-与-js引擎-互斥" class="sidebar-link">15.1 UI渲染线程 与 JS引擎 互斥</a></li><li class="sidebar-sub-header"><a href="/javascript/#_15-2-async和defer" class="sidebar-link">15.2 async和defer</a></li><li class="sidebar-sub-header"><a href="/javascript/#_15-3-js加载时间线" class="sidebar-link">15.3 js加载时间线</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_16-深拷贝与浅拷贝" class="sidebar-link">16 深拷贝与浅拷贝</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_16-1-浅拷贝" class="sidebar-link">16.1 浅拷贝</a></li><li class="sidebar-sub-header"><a href="/javascript/#_16-2-深拷贝" class="sidebar-link">16.2 深拷贝</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/#_17-前端模块化" class="sidebar-link">17. 前端模块化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#_17-1-commonjs" class="sidebar-link">17.1 CommonJS</a></li><li class="sidebar-sub-header"><a href="/javascript/#_17-2-amd" class="sidebar-link">17.2 AMD</a></li><li class="sidebar-sub-header"><a href="/javascript/#_17-3-cmd" class="sidebar-link">17.3 CMD</a></li><li class="sidebar-sub-header"><a href="/javascript/#_17-4-es-module" class="sidebar-link">17.4 ES Module</a></li></ul></li></ul></li><li><a href="/interviews/" class="sidebar-link">Interviews</a></li><li><a href="/project/" class="sidebar-link">Project</a></li><li><a href="/vue/" class="sidebar-link">Vue</a></li><li><a href="/typescript/" class="sidebar-link">TypeScript</a></li><li><a href="/database/" class="sidebar-link">Database</a></li><li><a href="/unorganized/" class="sidebar-link">Unorganized</a></li><li><a href="/life/" class="sidebar-link">Life</a></li><li><a href="/neuroscience/" class="sidebar-link">Neuroscience</a></li><li><a href="/webpack/" class="sidebar-link">Webpack</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javascript"><a href="#javascript" class="header-anchor">#</a> JavaScript</h1> <h2 id="_1-var-let-const-和变量提升"><a href="#_1-var-let-const-和变量提升" class="header-anchor">#</a> 1. var &amp; let &amp; const 和变量提升</h2> <ul><li><p>变量提升：准确的说，它们都会存在变量提升，在JS编译的时候会把声明语句拆分为声明语句和赋值语句，声明语句先执行，只不过对于<code>let</code>和<code>const</code>而言，声明语句到赋值语句之间的这部分代码块是不用使用该变量的，称为暂存死区；而<code>var</code>声明的变量，在未运行到赋值代码之前，值为<code>undefined</code></p></li> <li><p><code>var</code>可以重复声明，<code>var</code>是函数作用域，<code>let</code>和<code>const</code>是块级作用域</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>foo <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> foo<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出18，变量提升</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code>foo <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> foo<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ReferenceError 暂存死区内不可使用变量</span>
</code></pre></div></li> <li><p>函数：函数声明会被提升，并且优先于变量声明，但是函数表达式不会提升。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> foo<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 3</span>
<span class="token comment">// 2</span>

<span class="token comment">// 两个foo的声明都被提升，并且第二个覆盖了第一个</span>
<span class="token comment">// 重复的foo=function...的声明被忽略，但仍然在第二次调用foo前生效</span>
</code></pre></div></li></ul> <h2 id="_2-八大数据类型"><a href="#_2-八大数据类型" class="header-anchor">#</a> 2. 八大数据类型</h2> <h3 id="_2-1-概念"><a href="#_2-1-概念" class="header-anchor">#</a> 2.1 概念</h3> <ul><li><p>原始数据类型（7）：Boolean、Null、Undefined、Number、BigInt、String、Symbol</p></li> <li><p>引用类型（1）：Object</p></li> <li><p>其他的引用类型（5）：Array、Function、Date、RegExp、Set</p></li> <li><p><code>Polyfill</code>是一块代码（通常是 Web 上的 JavaScript），用来为旧浏览器提供它没有原生支持的较新的功能。</p></li> <li><p>Object和Map的区别</p> <table><thead><tr><th style="text-align:center;">方面</th> <th style="text-align:center;">Map</th> <th style="text-align:center;">Object</th></tr></thead> <tbody><tr><td style="text-align:center;">结构</td> <td style="text-align:center;">纯哈希结构</td> <td style="text-align:center;">不是，拥有自己的内部逻辑</td></tr> <tr><td style="text-align:center;">键的类型</td> <td style="text-align:center;">任意，可以是函数、对象或者任意基本类型</td> <td style="text-align:center;">必须是String类型或者Symbol类型</td></tr> <tr><td style="text-align:center;">键的顺序</td> <td style="text-align:center;">key是按照插入的顺序保存的</td> <td style="text-align:center;">无序的（也不完全是无序，不同类型不一样）</td></tr> <tr><td style="text-align:center;">Size</td> <td style="text-align:center;"><code>.size</code>获取</td> <td style="text-align:center;">键值对的个数只能手动获取</td></tr> <tr><td style="text-align:center;">迭代</td> <td style="text-align:center;">可以直接被迭代</td> <td style="text-align:center;">迭代键，来获取值</td></tr></tbody></table></li></ul> <h3 id="_2-2-为什么引用数据类型会变化呢？"><a href="#_2-2-为什么引用数据类型会变化呢？" class="header-anchor">#</a> 2.2 为什么引用数据类型会变化呢？</h3> <ul><li>基本数据类型的变量的值是存储在<strong>调用栈</strong>中，可以直接在调用栈中改变基本数据类型的变量的值。</li> <li>引用数据类型的变量也是存储在<strong>调用栈</strong>中的，但是这个值是一个地址，该地址对应的内存空间中的位置才是存储的该引用数据类型的变量的真正的值，这些值是存储在<strong>堆空间</strong>中的，所以对这一个值进行修改，其他的引用得到的结果也发生了同步变化。</li></ul> <h3 id="_2-3-null和undefined的区别"><a href="#_2-3-null和undefined的区别" class="header-anchor">#</a> 2.3 <code>null</code>和<code>undefined</code>的区别</h3> <ul><li>含义：
<ul><li>null：“没有对象”，此处不应该有具体值，应该为空</li> <li>undefined：“缺少值”，此处应该有值，但是还没有被定义</li></ul></li> <li>类型：
<ul><li><code>typeof null === 'object'</code></li> <li><code>typeof undefined = 'undefined'</code></li></ul></li> <li>数值：
<ul><li><code>Number(null) === 0</code></li> <li><code>Number(undefined) === NaN</code>，意为“Not a Number”</li></ul></li></ul> <h2 id="_3-闭包"><a href="#_3-闭包" class="header-anchor">#</a> 3. 闭包</h2> <h3 id="_3-1-产生闭包："><a href="#_3-1-产生闭包：" class="header-anchor">#</a> 3.1 产生闭包：</h3> <ul><li>预扫描内部函数</li> <li>把内部函数引用的外部变量保存到堆中（若无闭包，本来应该保存在栈中）</li> <li>其实闭包也可以理解为：在调用栈中，函数执行完毕之后，函数的执行上下文从栈顶弹出，但是留下了词法作用域中被其内部函数所引用的变量。</li></ul> <h3 id="_3-2-概念"><a href="#_3-2-概念" class="header-anchor">#</a> 3.2 概念</h3> <p>在 JavaScript 中，根据词法作用域的规则，内部函数总是可以访问其外部函数中声明的变量，当通过调用一个外部函数返回一个内部函数后，即使该外部函数已经执行结束了，但是内部函数引用外部函数的变量依然保存在内存中，我们就把这些变量的集合称为闭包。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 补充一个例子</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">18</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 正常输出了 0 ~ 17</span>
<span class="token comment">// 需要注意的是，for循环头部的let声明会有一个特殊的行为：即该变量在循环过程中不止被声明一次，每次迭代都会声明</span>
</code></pre></div><h3 id="_3-3-应用场景"><a href="#_3-3-应用场景" class="header-anchor">#</a> 3.3 应用场景</h3> <h4 id="_3-3-1-settimeout（还有就是防抖、节流）"><a href="#_3-3-1-settimeout（还有就是防抖、节流）" class="header-anchor">#</a> 3.3.1 setTimeout（还有就是防抖、节流）</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// j = i</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-3-2-工厂函数"><a href="#_3-3-2-工厂函数" class="header-anchor">#</a> 3.3.2 工厂函数</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">makeSizer</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> size12 <span class="token operator">=</span> <span class="token function">makeSizer</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> size14 <span class="token operator">=</span> <span class="token function">makeSizer</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> size16 <span class="token operator">=</span> <span class="token function">makeSizer</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'size-12'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> size12<span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'size-14'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> size14<span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'size-16'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>onclick <span class="token operator">=</span> size16<span class="token punctuation">;</span>

<span class="token comment">// 生产不同的函数，这样为不同的按钮添加点击事件处理程序</span>
</code></pre></div><h4 id="_3-3-3-私有变量"><a href="#_3-3-3-私有变量" class="header-anchor">#</a> 3.3.3 私有变量</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 私有变量：函数中定义的变量</span>
<span class="token keyword">function</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 私有变量和私有函数</span>
  <span class="token keyword">var</span> privateVariable <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  
  <span class="token keyword">function</span> <span class="token function">privateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 特权方法</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">publicMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    privateVariable<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">privateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// obj1 与 obj2 并不共享私有变量</span>

<span class="token comment">// 另一个浅显的例子</span>
<span class="token keyword">function</span> <span class="token function">Fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'tom'</span><span class="token punctuation">;</span>
  
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> fun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出undefined,在外部无法直接访问name</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//可以通过特定方法去访问</span>

<span class="token comment">// 对象属性有两种：数据属性，访问器属性，访问器属性就有点像是这个</span>
<span class="token comment">// 数据属性：configurable、enumerable、writable、value</span>
<span class="token comment">// 访问器属性：configurable、enumerate、get、set</span>
</code></pre></div><h4 id="_3-3-4-单例模式"><a href="#_3-3-4-单例模式" class="header-anchor">#</a> 3.3.4 单例模式</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">singleton</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 私有变量和私有函数</span>
  <span class="token keyword">var</span> privateVariable <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">privateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 特权/公有方法和属性</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    publicProperty<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">publicMethod</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      privateVariable<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">privateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用一个返回对象的匿名函数，在这个匿名函数内部，首先定义了私有变量和函数。</span>
<span class="token comment">// 然后，将一个对象字面量作为函数的返回值返回。</span>
<span class="token comment">// 返回的对象字面量中只包含可以公开的属性和方法</span>
</code></pre></div><h4 id="_3-3-5-柯里化"><a href="#_3-3-5-柯里化" class="header-anchor">#</a> 3.3.5 柯里化</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">21</span>

<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  fn<span class="token punctuation">.</span><span class="token function-variable function">toValue</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> ans <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ans<span class="token punctuation">.</span><span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 什么是柯里化？将函数与传递给函数的参数结合在一起，产生出一个新的函数（有点工厂函数的意思？）</span>
Function<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token string">'curry'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
  <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">that</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-settimeout-setinterval"><a href="#_4-settimeout-setinterval" class="header-anchor">#</a> 4. setTimeout &amp; setInterval</h2> <h3 id="_4-1-chrome实现settimeout"><a href="#_4-1-chrome实现settimeout" class="header-anchor">#</a> 4.1 Chrome实现setTimeout</h3> <p>chrome维护两个队列：1. 正常的<strong>消息队列</strong>  2. 另一个保存需要延迟执行的<strong>消息队列</strong></p> <ul><li>当执行<code>setTimeout</code>的时候，设置一个定时器，然后继续执行后面的代码</li> <li>定时器时间到，将<code>setTimeout</code>中的任务放到保存延迟执行任务的消息队列中，但并不立即执行</li> <li>当目前js引擎正在处理的任务结束时，才从延迟执行任务的消息队列中取出任务，进行执行</li></ul> <h3 id="_4-2-settimeout的注意点"><a href="#_4-2-settimeout的注意点" class="header-anchor">#</a> 4.2 setTimeout的注意点</h3> <ol><li>如果 setTimeout 存在嵌套调用，那么系统会设置<strong>最短时间间隔</strong>为 4 毫秒，因为在 Chrome 中，定时器被嵌套调用 5 次以上，系统会判断该函数方法被阻塞了。</li> <li>未激活的页面，<code>setTimeout</code>执行的最小间隔是1000毫秒，目的是为了优化后台页面的加载损耗以及降低耗电量。</li> <li>延迟执行时间有最大值，Chrome、Safari、Firefox 都是以 32 个 bit 来存储延时值的，32bit 最大只能存放的数字是 2147483647 毫秒（即24.8天）。</li></ol> <h3 id="_4-3-setinterval"><a href="#_4-3-setinterval" class="header-anchor">#</a> 4.3 setInterval</h3> <ol><li>机制：首先创建一个<code>delay</code>的定时器，然后每隔<code>delay</code>的时间，（<strong>在任务队列中没有定时器中的代码实例的时候</strong>）向任务队列的尾部加入一个定时器中代码的实例<code>func</code>，等到<code>func</code>前面的任务都被执行完毕，再执行<code>func</code>。</li> <li>目标：希望<code>func</code>任务能够以<code>delay</code>的时间间隔执行。（这里并不关心上一个任务结束与下一个任务开始之间的时间间隔）</li> <li>注意：<strong><code>setInterval()</code>仅当任务队列中没有定时器的任何其他代码实例时，才会将定时器代码加到队列中。</strong> <ul><li>多个定时器的代码执行之间的间隔可能会比预期的小：第二个定时器的任务已经被加入到队列了，第一个定时器的任务还在执行</li> <li>某些间隔会被跳过：第三个定时器都到表了，准备向队列中添加第三个定时器任务了，第一个定时器的任务还在执行</li></ul></li></ol> <h2 id="_5-promise"><a href="#_5-promise" class="header-anchor">#</a> 5. promise</h2> <h3 id="_5-1-概念"><a href="#_5-1-概念" class="header-anchor">#</a> 5.1 概念</h3> <ul><li>所谓<code>Promise</code>，简单说就是一个容器，里面保存着某个未来才会结束的事件（通常是一个异步操作）的结果。</li> <li>从语法上说，Promise 是一个对象，从它可以获取异步操作的消息。Promise 提供统一的 API，各种异步操作都可以用同样的方法进行处理。</li> <li>三种状态：pending（进行中）、fulfilled（已成功）、rejected（已失败）</li> <li>JS异步编程的六种方案：
<ul><li>回调函数callback</li> <li>事件监听 on / addEventListener</li> <li>发布-订阅者模式 / 观察者模式</li> <li>Promise/ A+</li> <li>生成器 Generators / yield</li> <li>Async / Await</li></ul></li></ul> <h3 id="_5-2-一些特性和-promise-a"><a href="#_5-2-一些特性和-promise-a" class="header-anchor">#</a> 5.2 一些特性和 Promise/A+</h3> <h4 id="_5-2-1-特性"><a href="#_5-2-1-特性" class="header-anchor">#</a> 5.2.1 特性</h4> <ul><li>Promise 对象的错误具有“冒泡”性质，会一直向后传递，直到被<code>onReject</code>函数处理或<code>catch</code>语句捕获为止。</li> <li><code>onFulfilled</code>和<code>onRejected</code>都是微任务，并且这两个函数都只能执行一次，但是<code>then</code>可以多次执行。</li> <li><code>resolve</code>、<code>reject</code>函数应该不是<code>setTimeout</code>来实现异步的，虽然手写是这么实现的。</li> <li><strong>还是没太明白：</strong><code>resolve</code>是异步，<code>reject</code>接收到一个<code>reject</code>状态的<code>promise</code>的时候，不是异步，遇到<code>then</code>的时候会立即执行？并且以接收到的这个<code>reject</code>状态的<code>promise</code>作为参数调用自己的<code>reject()</code>函数。例子见 5.11 习题十一</li></ul> <h4 id="_5-2-2-promise-a"><a href="#_5-2-2-promise-a" class="header-anchor">#</a> 5.2.2 Promise/A+</h4> <ul><li><code>then</code>必须返回一个 promise，即<code>promise2 = promise1.then(onFulfilled, onRejected);</code> <ul><li>不论<code>promise1</code>被<code>reject</code>还是<code>resolve</code>,<code>promise2</code>都会被<code>resolve</code>，只有出现异常<code>promise2</code>才会被<code>reject</code></li> <li><code>onFulfilled</code>和<code>onRejected</code>如果出现了错误（抛出异常，非正常执行完毕），都会返回一个 rejected promise 新实例。</li></ul></li> <li><strong>Promise 解决过程</strong> 是一个抽象的操作，其需输入一个 <code>promise</code> 和一个值，我们表示为 <code>[[Resolve]](promise, x)</code> <ul><li>如果 <code>x</code> 是一个值，则其用 <code>x</code> 的值来执行 <code>promise</code></li> <li>如果 <code>x</code> 是函数或者对象，递归尝试<code>x.then()</code>（或者说，返回的 Promise 对象会“跟随”这个 thenable 的对象，采用它的最终状态（指 resolved/rejected/pending/settled））</li> <li>如果 <code>x</code> 和 <code>promise</code> 指向同一对象，以<code>TypeError</code>为据因，拒绝执行<code>promise</code>（<code>TypeError: Chaining cycle detected for promise</code>）</li> <li>如果 <code>x</code> 有 <code>then</code> 方法且看上去像一个 Promise ，解决程序即尝试使 <code>promise</code> 接受 <code>x</code> 的状态；
<ul><li><strong>如果 <code>x</code> 处于等待态， <code>promise</code> 需保持为等待态直至 <code>x</code> 被执行或拒绝</strong></li> <li>如果 <code>x</code> 处于执行态，用相同的值执行 <code>promise</code></li> <li>如果 <code>x</code> 处于拒绝态，用相同的据因拒绝 <code>promise</code></li></ul></li></ul></li></ul> <h3 id="_5-3-promise-的返回值"><a href="#_5-3-promise-的返回值" class="header-anchor">#</a> 5.3 promise 的返回值</h3> <p><code>resolve</code>和<code>reject</code>两个函数只会有一个被调用，函数的返回值将被用作创建then返回的Promise对象。这两个参数的返回值可以是以下三种情况中的一种：</p> <ul><li><code>return</code> 一个同步的值 ，或者 <code>undefined</code>（当没有返回一个有效值时，默认返回undefined），<code>then</code>方法将返回一个resolved状态的Promise对象，Promise对象的值就是这个返回值。</li> <li><code>return</code> 另一个 Promise，<code>then</code>方法将根据这个Promise的状态和值创建一个新的Promise对象返回。</li> <li><code>throw</code> 一个同步异常，<code>then</code>方法将返回一个rejected状态的Promise,  值是该异常。</li></ul> <h3 id="_5-4-api"><a href="#_5-4-api" class="header-anchor">#</a> 5.4 API</h3> <h4 id="_5-4-1-promise-resolve-："><a href="#_5-4-1-promise-resolve-：" class="header-anchor">#</a> 5.4.1 <code>promise.resolve(...)</code> ：</h4> <ul><li>该方法返回一个以给定值解析后的<code>Promise</code>对象：
<ul><li>当参数是一个<code>Promise</code>对象时，它直接返回这个<code>Promise</code>。</li> <li>当参数是普通值时，它返回一个<code>resolved</code>状态的<code>Promise</code>对象，对象的值就是这个参数。</li></ul></li> <li>即使<code>executor</code>函数中包含了同步执行的<code>resolve(p1)</code>，但通过new的方式创建的Promise对象都是一个新的对象。</li></ul> <h4 id="_5-4-2-promise-reject-reason-："><a href="#_5-4-2-promise-reject-reason-：" class="header-anchor">#</a> 5.4.2 <code>promise.reject(reason)</code>：</h4> <ul><li>该方法返回一个带有拒绝原因的<code>Promise</code>对象。</li></ul> <h4 id="_5-4-3-promise-race-iterable"><a href="#_5-4-3-promise-race-iterable" class="header-anchor">#</a> 5.4.3 <code>promise.race(iterable)</code></h4> <ul><li>多个<code>Promise</code>任务同时执行，返回最先执行结束的<code>Promise</code>任务的结果，不管这个<code>Promise</code>结果是成功还是失败。</li></ul> <h4 id="_5-4-4-promise-any-iterable"><a href="#_5-4-4-promise-any-iterable" class="header-anchor">#</a> 5.4.4 <code>promise.any(iterable)</code></h4> <ul><li>接收一个<code>promise</code>可迭代对象，只要其中的一个 <code>promise</code> 完成，就返回那个已经有完成值的 <code>promise</code> 。</li> <li>如果可迭代对象中没有一个 <code>promise</code> 完成（即所有的 <code>promises</code> 都失败/拒绝），就返回一个拒绝的 <code>promise</code>，返回值还有待商榷。</li></ul> <h4 id="_5-4-5-promise-all-iterable"><a href="#_5-4-5-promise-all-iterable" class="header-anchor">#</a> 5.4.5 <code>promise.all(iterable)</code></h4> <ul><li>这个方法返回一个新的<code>promise</code>对象，该<code>promise</code>对象在<code>iterable</code>参数对象里所有的<code>promise</code>对象都成功的时候才会触发成功。</li> <li>一旦有任何一个<code>iterable</code>里面的<code>promise</code>对象失败则立即触发该<code>promise</code>对象的失败，失败的原因是第一个失败<code>promise</code> 的结果。</li></ul> <h3 id="_5-4-promise-执行时序总结"><a href="#_5-4-promise-执行时序总结" class="header-anchor">#</a> 5.4 promise 执行时序总结</h3> <ul><li>前一个<code>promise</code>如果返回了新的<code>promise</code>，则后面的<code>promise</code>要等待其结果，并根据前面的<code>promise</code>创建一个新的<code>promise</code>（与前面这个<code>promise</code>的状态相同）返回。</li> <li>不管创建<code>promise</code>实例时还是创建完<code>promise</code>实例后，只要执行了<code>resolve()</code>或者<code>reject()</code>就会改变<code>promise</code>的状态，并且这个状态只能改变一次。</li> <li>在<code>pending</code>状态下，<code>then</code>只是将传给<code>then</code>的参数（一个函数）推送到该<code>promise</code>的回调队列中，但是并不执行。</li> <li>两个链式调用的<code>then</code>，第二个<code>then</code>中的代码需要等待第一个<code>then</code>中的同步代码执行完毕才能执行。</li> <li>两个同步调用的<code>then</code>，是顺序（几乎同时）执行的，第一个<code>then</code>在等待回调的时候，就进入执行第二个<code>then</code>，二者交替执行。</li> <li>猜测：<code>resolved</code>状态下，<code>then</code>的参数（一个函数）应该是直接被放倒了微任务队列中，因此<code>then</code>可以多次执行</li> <li>猜测：执行<code>resolve</code>的时候会检查该<code>promise</code>的回调队列中有没有未执行的任务，有则放入微任务队列中。</li> <li>疑惑：我不确定<code>then</code>注册的时候是不是直接注册的，即同时放入微任务队列</li></ul> <h3 id="_5-5-实现一个简单的-promise"><a href="#_5-5-实现一个简单的-promise" class="header-anchor">#</a> 5.5 实现一个简单的 promise</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 但这个 promise 还有几个缺陷：</span>

<span class="token comment">// 1.then 方法返回的是 this，本应该返回一个新的 promise 实例。因此，不支持串行异步任务</span>
<span class="token comment">// 诸如：串行异步任务：p.then(f1).then(f2).then(f3).catch(errorLog)，分别读取文件 f1、f2、f3 并且在读取完之后打印</span>
<span class="token comment">// 但这个会一直输出 f1、f1、f1，因为这几个任务都放到了 p1 的回调队列 onFulfilledCallbacks 里面</span>

<span class="token comment">// 2.一个状态为 resolve / reject 的 promise，在调用 then 的时候，也不应该被立即执行</span>

<span class="token comment">// 3.在代码执行了函数 resolve() / reject() 之后，手写代码并没有马上将状态改为 resolved / rejected，而是等待 resolve() / reject() 的回调函数执行了之后，才更改状态，而在真正的 promise 中，是立即改变的。</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 终极版</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">bridgepromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bridgepromise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Circular reference'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgepromise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgepromise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bridgePromise<span class="token punctuation">;</span>
  onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
  onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPromise<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-6-手写实现串行异步任务的思路"><a href="#_5-6-手写实现串行异步任务的思路" class="header-anchor">#</a> 5.6 手写实现串行异步任务的思路</h3> <ul><li>**<code>let promise2 = new Promise(...)</code>：**then 不再返回自身实例，而是一个新的promise对象，衔接后续操作</li> <li>**<code>resolvePromise(promise2, x, resolve, reject)</code>：**一个函数，用来解析回调函数的返回值x，x可能是普通值也可能是个promise对象，同时还可能等于<code>promise2</code>，即<code>x === promise2</code>，此时应当 reject promise with a TypeError</li> <li>在<code>then</code>中通过调用<code>resolvePromise</code>方法，判断当前调用<code>resolve(value)</code>的返回值是一个普通值还是promise对象：
<ul><li>如果是promise对象：
<ul><li>如果为<code>pending</code>状态，则继续往下走，继续执行<code>resolvePromise</code>判断这个promsie的返回值是普通值还是promise对象。</li> <li>否则，执行<code>x.then(resolve, reject)</code></li></ul></li> <li>否则，是正常值，则执行<code>resolve(x)</code></li></ul></li> <li>其实我自己的理解就是：判断当前promise中的resolve的onFulfilled函数返回的是不是一个promise对象，如果是返回的是一个promise并且该对象为pending状态，则在这个promise里面解析它的结果。<strong>本质上应该是是切换了不同的执行上下文，让当前的this指向不同阶段的promise实例，并将传给 then() 的参数 onFulfilled 和 onRejected 函数，push 到对应的 promise实例的 callback 队列中，避免了所有的回调函数都被 push 到最开始的那个promise实例中，也就是相当于这些回调函数，都被这个最开始的promise执行，导致每次的执行结果都一样。</strong></li></ul> <h2 id="_6-对象"><a href="#_6-对象" class="header-anchor">#</a> 6.对象</h2> <h3 id="_6-1-属性类型"><a href="#_6-1-属性类型" class="header-anchor">#</a> 6.1 属性类型</h3> <h4 id="_6-1-1-数据属性"><a href="#_6-1-1-数据属性" class="header-anchor">#</a> 6.1.1 数据属性</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;range&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-1-2-访问器属性"><a href="#_6-1-2-访问器属性" class="header-anchor">#</a> 6.1.2 访问器属性</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 访问器属性不包含数据值，它们包含一对儿getter和setter函数，都是可选的</span>
<span class="token keyword">var</span> book <span class="token operator">=</span> <span class="token punctuation">{</span>
  _year<span class="token operator">:</span> <span class="token number">2004</span><span class="token punctuation">,</span>
  edition<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// 访问器属性不能直接定义，必须使用 Object.defineProperty()来定义</span>
<span class="token comment">// 这里就定义了一个 year 的访问器属性</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> <span class="token string">&quot;year&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_year<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">&gt;</span> <span class="token number">2004</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_year <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>edition <span class="token operator">+=</span> newValue <span class="token operator">-</span> <span class="token number">2004</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-2-创建对象"><a href="#_6-2-创建对象" class="header-anchor">#</a> 6.2 创建对象</h3> <ul><li>工厂模式</li> <li>构造函数模式</li> <li>原型模式</li> <li>组合模式</li> <li>动态原型模式</li> <li>寄生构造函数模式</li> <li>稳妥构造函数模式</li></ul> <h4 id="_6-2-1-工厂模式"><a href="#_6-2-1-工厂模式" class="header-anchor">#</a> 6.2.1 工厂模式</h4> <p>但是工厂模式没有解决对象识别的问题（即怎么样知道一个对象的类型）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  o<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  o<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  o<span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">'foolish'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_6-2-2-构造函数模式"><a href="#_6-2-2-构造函数模式" class="header-anchor">#</a> 6.2.2 构造函数模式</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 步骤</span>
<span class="token comment">// 1.创建一个新对象</span>
<span class="token comment">// 2.将构造函数的作用域赋给新对象，因此 this 就指向了这个新对象</span>
<span class="token comment">// 3.执行构造函数中的代码，为这个新对象添加属性</span>
<span class="token comment">// 4.返回新对象</span>

<span class="token comment">// 但是每次都要生成一个新的 function 对象，就是 sayName指向的那个</span>
<span class="token comment">// 不同的实例中的 sayName 不是同一个，它们都是该 function 的一个实例</span>
</code></pre></div><h4 id="_6-2-3-原型模式"><a href="#_6-2-3-原型模式" class="header-anchor">#</a> 6.2.3 原型模式</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Range&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>job <span class="token operator">=</span> <span class="token string">&quot;Student&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 或者</span>
<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;Range&quot;</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
  job<span class="token operator">:</span> <span class="token string">&quot;Student&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">sayName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_6-2-4-组合模式（构造函数模式-原型模式）"><a href="#_6-2-4-组合模式（构造函数模式-原型模式）" class="header-anchor">#</a> 6.2.4 组合模式（构造函数模式 + 原型模式）</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>job <span class="token operator">=</span> job<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  constructor<span class="token operator">:</span> Person<span class="token punctuation">,</span>
  <span class="token function-variable function">sayName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-2-5-动态原型模式"><a href="#_6-2-5-动态原型模式" class="header-anchor">#</a> 6.2.5 动态原型模式</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getName <span class="token operator">!=</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意：使用动态原型模式时，<strong>不能用对象字面量重写原型</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getName <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Person</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token comment">// 这里使用了对象字面量进行赋值</span>
            constructor<span class="token operator">:</span> Person<span class="token punctuation">,</span>
            <span class="token function-variable function">getName</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用字面量进行赋值，相当于将一个新的地址传给了 Person.prototype</span>
<span class="token comment">// 但是 new 的过程：</span>
<span class="token comment">// 1.新建一个对象obj</span>
<span class="token comment">// 2.将obj的__proto__ 指向 Person.prototype</span>
<span class="token comment">// 3.Person.apply(obj)</span>
<span class="token comment">// 4.return obj</span>
<span class="token comment">// 注意第二步，这里传入的是 Person.prototype 的地址</span>
<span class="token comment">// 所以第三步里面，是给 Person.prototype 赋值了一个新的对象，传入的是地址，而没有改变原先的地址中的值</span>
<span class="token comment">// 所以这里，obj 仍然指向的是原先的 Person.prototype的地址，也就是说，没有发生对应的改变</span>
</code></pre></div><h4 id="_6-2-6-寄生构造函数模式"><a href="#_6-2-6-寄生构造函数模式" class="header-anchor">#</a> 6.2.6 寄生构造函数模式</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  o<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> o
<span class="token punctuation">}</span>

<span class="token comment">// 寄生-在-构造函数-的模式</span>
<span class="token comment">// 在构造函数中创建新的对象，并且返回</span>
<span class="token comment">// 实例与构造函数没有什么关系</span>

<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注意寄生构造函数模式与工厂模式在构造函数上并没有区别</span>
<span class="token comment">// 区别在于实例化的时候，寄生构造函数使用了 new</span>
<span class="token comment">// 而工厂模式则直接使用了 构造函数返回的对象。</span>
</code></pre></div><h4 id="_6-2-7-稳妥构造函数模式"><a href="#_6-2-7-稳妥构造函数模式" class="header-anchor">#</a> 6.2.7 稳妥构造函数模式</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  o<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> friend <span class="token operator">=</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token string">&quot;range&quot;</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token string">&quot;Student&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
friend<span class="token punctuation">.</span><span class="token function">sayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;range&quot;</span>

<span class="token comment">// 利用闭包在内存中保留了传入的 name 属性</span>
<span class="token comment">// 新创建对象的实例不引用 this</span>
<span class="token comment">// 不使用 new 操作符调用构造函数</span>
</code></pre></div><h2 id="_7-继承"><a href="#_7-继承" class="header-anchor">#</a> 7. 继承</h2> <h3 id="_7-1-原型"><a href="#_7-1-原型" class="header-anchor">#</a> 7.1 原型</h3> <p><img src="/imgs/prototype.png" alt="image"></p> <h3 id="_7-2-继承"><a href="#_7-2-继承" class="header-anchor">#</a> 7.2 继承</h3> <ul><li>原型链继承</li> <li>借用构造继承</li> <li>组合继承</li> <li>原型式继承</li> <li>寄生式继承</li> <li>寄生组合式继承</li> <li>ES6类继承</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义一个动物类</span>
<span class="token keyword">function</span> <span class="token function">Animal</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">||</span> <span class="token string">'Animal'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is sleeping.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 原型方法</span>
<span class="token class-name">Animal</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">eat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is eating '</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cat<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// cat is sleeping.</span>
</code></pre></div><h4 id="_7-2-1-原型链继承"><a href="#_7-2-1-原型链继承" class="header-anchor">#</a> 7.2.1 原型链继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Cat</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Cat</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'cat'</span><span class="token punctuation">;</span>
<span class="token class-name">Cat</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Cat<span class="token punctuation">;</span>

<span class="token keyword">let</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cat<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 引用类型的属性被所有实例共享</span>
<span class="token comment">// 在创建子类型的实例的时候（就是 let cat = new Cat()的时候），不能向超类型的构造函数中传递参数</span>
<span class="token comment">// 注意这里还要修改 prototype 的 constructor</span>
</code></pre></div><h4 id="_7-2-2-借用构造继承"><a href="#_7-2-2-借用构造继承" class="header-anchor">#</a> 7.2.2 借用构造继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Cat</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">Animal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">||</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
  <span class="token comment">// Animal.call(this, name);</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> cat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cat<span class="token punctuation">.</span><span class="token function">sleeping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 避免了引用类型的属性被所有实例共享</span>
<span class="token comment">// 只能继承父类实例的属性和方法，不能继承父类原型上的属性和方法</span>
</code></pre></div><h4 id="_7-2-3-组合继承"><a href="#_7-2-3-组合继承" class="header-anchor">#</a> 7.2.3 组合继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Cat</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">Animal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token operator">||</span> <span class="token string">&quot;Tom&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// Animal.call(this, name);</span>
<span class="token punctuation">}</span>

<span class="token class-name">Cat</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Cat</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Cat<span class="token punctuation">;</span>

<span class="token comment">// 优点：可以继承实例属性/方法，也可以继承原型属性/方法</span>
<span class="token comment">// 缺点：需要调用两次超类型构造函数</span>
<span class="token comment">// 第一次：创建子类型原型的时候，就是上面的 new Animal()</span>
<span class="token comment">// 第二次：子类型构造函数的内部，就是上面的 Animal.call(this)；</span>
</code></pre></div><h4 id="_7-2-4-原型式继承"><a href="#_7-2-4-原型式继承" class="header-anchor">#</a> 7.2.4 原型式继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先创建一个临时性的构造函数，然后将传入的对象作为这个构造函数的原型</span>
  <span class="token comment">// 最后返回这个临时类型的一个新实例。</span>
  <span class="token comment">// 其中，object() 对传入其中的对象执行了一次浅拷贝</span>
  <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> obj<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注意这里通过类似 let f = object(obj) 形式实例化出来的 f 是没有构造函数（即constructor这个属性的）</span>
<span class="token comment">// 在 F.prototype = obj 这句之后，新构造的 new F() 的 constructor 就不是 F 了</span>

<span class="token comment">// 这个 person 其实就是作为一个我们可以看得见的 prototype</span>
<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span>
  friends<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> anotherPerson <span class="token operator">=</span> <span class="token function">object</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
anotherPerson<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">;</span>
anotherPerson<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;E&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> yetAnotherPerson <span class="token operator">=</span> <span class="token function">object</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
yetAnotherPerson<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">;</span>
yetAnotherPerson<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;G&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>friends<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  BCEG</span>

<span class="token comment">// ES5 通过新增 Object.create() 方法规范化了原型式继承</span>
<span class="token keyword">var</span> person <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span>
  friends<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> anotherPerson <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
anotherPerson<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">;</span>
anotherPerson<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;E&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> yetAnotherPerson <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
yetAnotherPerson<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">;</span>
yetAnotherPerson<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;G&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>friends<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  BCEG</span>
</code></pre></div><h4 id="_7-2-5-寄生式继承"><a href="#_7-2-5-寄生式继承" class="header-anchor">#</a> 7.2.5 寄生式继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createObj</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> clone <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clone<span class="token punctuation">.</span><span class="token function-variable function">sayName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hey.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> clone<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建一个仅用于封装继承过程的函数，该函数在内部以某种方式来克隆、增强对象，最后返回克隆的增强的对象</span>
</code></pre></div><h4 id="_7-2-6-寄生组合式继承"><a href="#_7-2-6-寄生组合式继承" class="header-anchor">#</a> 7.2.6 寄生组合式继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">inheritPrototype</span><span class="token punctuation">(</span><span class="token parameter">subType<span class="token punctuation">,</span> superType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>superType<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
    prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> subType
    subType<span class="token punctuation">.</span>prototype <span class="token operator">=</span> prototype
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">SuperType</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">SubType</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">SuperType</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">inheritPrototype</span><span class="token punctuation">(</span>SubType<span class="token punctuation">,</span> SuperType<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 只调用了一次超类 superType 的构造函数，避免了在 subType.prototype 上面创建不必要的多余的属性</span>
<span class="token comment">// 是引用类型最理想的继承范式</span>
</code></pre></div><h4 id="_7-2-7-es6类继承"><a href="#_7-2-7-es6类继承" class="header-anchor">#</a> 7.2.7 ES6类继承</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Polygon</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">height<span class="token punctuation">,</span> width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Polygon'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Polygon</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Square'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Getter</span>
  <span class="token keyword">get</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calcArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Method</span>
  <span class="token function">calcArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> square <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>square<span class="token punctuation">.</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100，注意这里不是调用函数</span>
</code></pre></div><p>ES5继承和ES6继承的区别：</p> <ul><li>ES5的继承实质上是先创建子类的实例对象，然后再将父类的方法添加到this上（Parent.call(this)）.</li> <li>ES6的继承有所不同，实质上是先创建父类的实例对象this，然后再用子类的构造函数修改this。因为子类没有自己的this对象，所以必须先调用父类的super()方法，否则新建实例报错。</li></ul> <h2 id="_8-dom事件流"><a href="#_8-dom事件流" class="header-anchor">#</a> 8. DOM事件流</h2> <h3 id="_8-1-事件流"><a href="#_8-1-事件流" class="header-anchor">#</a> 8.1 事件流</h3> <p>当一个HTML元素触发一个事件时，该事件会在元素结点与根结点之间的路径传播。传播按顺序分为三个阶段：<strong>捕获阶段、目标阶段、冒泡阶段</strong>，这个传播过程就是 DOM 事件流。</p> <ol><li>捕获阶段：从根节点window到目标节点</li> <li>目标阶段：目标节点上的事件触发按照代码执行顺序触发</li> <li>冒泡阶段：从目标节点到根节点</li></ol> <p>常用事件：</p> <ul><li><code>onclick：</code>点击</li> <li><code>onmouseover/onmouseout：</code>鼠标经过/离开</li> <li><code>onchange：</code>文本框内容改变</li> <li><code>onselect：</code>文本框内容被选中</li> <li><code>onfocuse/onblur：</code>光标聚集/离开</li> <li><code>onload/onunload：</code>网页导入（图片、样式、脚本都加载完毕）/关闭</li></ul> <h3 id="_8-2-事件处理程序"><a href="#_8-2-事件处理程序" class="header-anchor">#</a> 8.2 事件处理程序</h3> <ul><li>HTML 事件处理程序</li> <li>DOM 0 级事件处理程序</li> <li>DOM 2 级事件处理程序</li> <li>IE 事件处理程序</li> <li>跨浏览器的事件处理程序</li></ul> <h4 id="_8-3-1-html-事件处理程序"><a href="#_8-3-1-html-事件处理程序" class="header-anchor">#</a> 8.3.1 HTML 事件处理程序</h4> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 用一个与该事件处理程序同名的HTML特性来指定。--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Click me<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert(‘Clicked’)<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Click me<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert(<span class="token entity" title="&quot;">&amp;quot;</span>success<span class="token entity" title="&quot;">&amp;quot;</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Click me<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>showMessage()<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">showMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Done.&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_8-3-2-事件绑定与事件监听（dom-0-级事件处理程序）"><a href="#_8-3-2-事件绑定与事件监听（dom-0-级事件处理程序）" class="header-anchor">#</a> 8.3.2 事件绑定与事件监听（DOM 0 级事件处理程序）</h4> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 常规的事件绑定只执行最后绑定的事件。</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_8-3-3-事件监听（dom-2-级事件处理程序）"><a href="#_8-3-3-事件监听（dom-2-级事件处理程序）" class="header-anchor">#</a> 8.3.3 事件监听（DOM 2 级事件处理程序）</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;btn1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 事件监听可以绑定多个事件。</span>
</code></pre></div><h4 id="_8-3-4-ie-事件处理程序"><a href="#_8-3-4-ie-事件处理程序" class="header-anchor">#</a> 8.3.4 IE 事件处理程序</h4> <p>IE只支持事件冒泡，不支持事件捕获，它也不支持addEventListener函数，不会用第三个参数来表示是冒泡还是捕获。</p> <ul><li>attachEvent(事件处理程序名称，事件处理程序函数)；</li> <li>detachEvent(事件处理程序名称，事件处理程序函数)；</li> <li><strong>通过该方法添加的事件处理程序，都会被添加到冒泡阶段。</strong></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 添加多个事件处理程序。后添加先执行。</span>

<span class="token keyword">var</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
btn<span class="token punctuation">.</span><span class="token function">attachEvent</span> <span class="token punctuation">(</span>“onclick”<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
btn<span class="token punctuation">.</span><span class="token function">detachEvent</span> <span class="token punctuation">(</span>“onclick”<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_8-3-5-跨浏览器事件处理程序"><a href="#_8-3-5-跨浏览器事件处理程序" class="header-anchor">#</a> 8.3.5 跨浏览器事件处理程序</h4> <ul><li>创建一个方法<code>addHandler()</code>:区分使用哪种方法来添加事件；
<ul><li>依次尝试：
<ul><li>DOM 2级事件处理程序：<code>addEventListener</code></li> <li>IE 事件处理程序：<code>attachEvent</code></li> <li>HTML事件处理程序</li></ul></li></ul></li> <li>创建一个对象<code>EventUtil</code>。拥有两个方法。</li> <li><code>addHandler</code>(要操作的元素，事件名称，事件处理函数)。</li> <li><code>removeHandler</code>(要操作的元素，事件名称，事件处理函数)。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> EventUtil <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">addHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>type<span class="token punctuation">,</span>handler</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>addEventLister<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>handler<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token operator">+</span>type<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token string">&quot;on&quot;</span><span class="token operator">+</span>type<span class="token punctuation">]</span> <span class="token operator">=</span>handler<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">removeHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>type<span class="token punctuation">,</span>handler</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>addEventLister<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>handler<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span><span class="token function">detachEvent</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token operator">+</span>type<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token string">&quot;on&quot;</span><span class="token operator">+</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

EventUtil<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>btn <span class="token punctuation">,</span>”click”<span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
EventUtil<span class="token punctuation">.</span><span class="token function">removeHandler</span><span class="token punctuation">(</span>btn <span class="token punctuation">,</span>”click”<span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-3-停止传播"><a href="#_8-3-停止传播" class="header-anchor">#</a> 8.3 停止传播</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
button<span class="token punctuation">.</span><span class="token function">addEvenetListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 点击button会先后打印 button div</span>
</code></pre></div><h4 id="_8-3-1-addeventlistener-事件监听"><a href="#_8-3-1-addeventlistener-事件监听" class="header-anchor">#</a> 8.3.1 addEventListener 事件监听</h4> <p>通过设置 addEventListener 的<code>capture</code>参数可以决定事件是否在捕获阶段触发</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>，<span class="token punctuation">{</span>capture<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 或者</span>

div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>，<span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// 点击button就会先触发div的click事件，再触发button的click事件。</span>
<span class="token comment">// 即先打印 div 然后打印 button</span>
</code></pre></div><h4 id="_8-3-2-event-stoppropagation-阻止冒泡"><a href="#_8-3-2-event-stoppropagation-阻止冒泡" class="header-anchor">#</a> 8.3.2 event.stopPropagation() 阻止冒泡</h4> <p><code>stopPropagation</code>方法会让事件传播到目标阶段后停止传播，所以也叫阻止冒泡。相当于让事件流只剩下捕获阶段和目标阶段。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>，<span class="token boolean">true</span><span class="token punctuation">)</span>

div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 先打印 div1 然后打印 button</span>
</code></pre></div><h4 id="_8-3-3-event-stopimmediatepropagation-马上停止传播"><a href="#_8-3-3-event-stopimmediatepropagation-马上停止传播" class="header-anchor">#</a> 8.3.3 event.stopImmediatePropagation() 马上停止传播</h4> <p>有个特例，如果目标阶段的节点绑定了多个事件，它们不会区分捕获和冒泡，事件触发的顺序为代码执行的顺序，而且<code>event.stopPropagation()</code>在目标阶段不会生效。</p> <p>如果目标阶段有 a、b、c 三个触发事件会按顺序执行，在 b 事件里设置<code>event.stopPropagation()</code>并不会影响 c 事件的触发。 但是如果在 b 事件里设置<code>event.stopImmediatePropagation()</code>后 ，事件触发到b之后就会停止触发后面的所有事件。</p> <h4 id="_8-3-4-preventdefault-阻止默认事件，但不阻止传播"><a href="#_8-3-4-preventdefault-阻止默认事件，但不阻止传播" class="header-anchor">#</a> 8.3.4 preventDefault() 阻止默认事件，但不阻止传播</h4> <p>告诉User Agent：如果此事件没有被显式处理，它默认的动作也不应该照常执行。此事件还是继续传播，除非碰到事件侦听器调用<code>stopPropagation()</code> 或<code>stopImmediatePropagation()</code>，才停止传播。</p> <h3 id="_8-4-事件委托（事件代理）"><a href="#_8-4-事件委托（事件代理）" class="header-anchor">#</a> 8.4 事件委托（事件代理）</h3> <h4 id="_8-4-1-概念"><a href="#_8-4-1-概念" class="header-anchor">#</a> 8.4.1 概念</h4> <ul><li>通俗的说就是将元素的事件委托给它的父级或者更外级的元素处理，它的实现机制就是事件冒泡。</li> <li>事件委托就是利用事件冒泡，只制定一个时间处理程序，就可以管理某一类型的所有事件。</li> <li>DOM遍历 + 事件冒泡。</li> <li>个人理解：冒泡本质上是触发事件的<strong>event.target</strong>的向上传播</li></ul> <h4 id="_8-4-2-例子"><a href="#_8-4-2-例子" class="header-anchor">#</a> 8.4.2 例子</h4> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>color_list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>red<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>orange<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>yellow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>green<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>blue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>purple<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.color_list</span><span class="token punctuation">{</span>            
    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>            
    <span class="token property">display</span><span class="token punctuation">:</span> -webkit-flex<span class="token punctuation">;</span>        
<span class="token punctuation">}</span>        
<span class="token selector">.color_list li</span><span class="token punctuation">{</span>            
    <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>            
    <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>            
    <span class="token property">list-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>            
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>            
    <span class="token property">line-height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>        
<span class="token punctuation">}</span>
<span class="token selector">//每个li加上对应的颜色，此处省略
.box</span><span class="token punctuation">{</span>            
    <span class="token property">width</span><span class="token punctuation">:</span> 600px<span class="token punctuation">;</span>            
    <span class="token property">height</span><span class="token punctuation">:</span> 150px<span class="token punctuation">;</span>            
    <span class="token property">background-color</span><span class="token punctuation">:</span> #cccccc<span class="token punctuation">;</span>            
    <span class="token property">line-height</span><span class="token punctuation">:</span> 150px<span class="token punctuation">;</span>            
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 不使用事件委托</span>
<span class="token comment">// 需要给每一个 li 元素添加一个 eventListener</span>
<span class="token keyword">var</span> color_list<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.color_list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
<span class="token keyword">var</span> colors<span class="token operator">=</span>color_list<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
<span class="token keyword">var</span> box<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.box&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> n<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>n<span class="token operator">&lt;</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">;</span>n<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                
    colors<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>                    
        box<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">&quot;该颜色为 &quot;</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>                
    <span class="token punctuation">}</span><span class="token punctuation">)</span>            
<span class="token punctuation">}</span>

<span class="token comment">// 使用事件委托</span>
<span class="token comment">// 只需要给 ul 元素添加一个事件即可</span>
<span class="token keyword">function</span> <span class="token function">colorChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                
    <span class="token keyword">var</span> e<span class="token operator">=</span>e<span class="token operator">||</span>window<span class="token punctuation">.</span>event<span class="token punctuation">;</span><span class="token comment">//兼容性的处理         </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    
        box<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">&quot;该颜色为 &quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>                
    <span class="token punctuation">}</span>                            
<span class="token punctuation">}</span>            
color_list<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>colorChange<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>由于事件冒泡机制，点击了 li 后会冒泡到 ul ，此时就会触发绑定在 ul 上的点击事件，再利用 target 找到事件实际发生的元素，就可以达到预期的效果。</strong></p> <h4 id="_8-4-3-特点"><a href="#_8-4-3-特点" class="header-anchor">#</a> 8.4.3 特点</h4> <ul><li>只需要将同类元素的事件委托给父级或者更外级的元素，不需要给所有的元素都绑定事件，减少内存占用空间，提升性能。</li> <li>动态新增的元素无需重新绑定事件</li> <li>提高JavaScript性能。事件委托可以显著的提高事件的处理速度，减少内存的占用。</li> <li><code>ajax</code>的局部刷新，导致每次加载完，都要重新绑定事件。事件委托避免了这一点。</li></ul> <p>注意点：</p> <ul><li>事件委托的实现依靠的冒泡，因此不支持事件冒泡的事件就不适合使用事件委托。</li> <li>不是所有的事件绑定都适合使用事件委托，不恰当使用反而可能导致不需要绑定事件的元素也被绑定上了事件。</li></ul> <h2 id="_9-error"><a href="#_9-error" class="header-anchor">#</a> 9. Error</h2> <h3 id="_9-1-error的标准属性"><a href="#_9-1-error的标准属性" class="header-anchor">#</a> 9.1 Error的标准属性</h3> <ul><li><code>Error.prototype.name</code> ：错误的名字</li> <li><code>Error.prototype.message</code>：错误的描述</li> <li><code>Error.prototype.toString</code>：返回表示一个表示错误的字符串。</li></ul> <h3 id="_9-2-error的种类"><a href="#_9-2-error的种类" class="header-anchor">#</a> 9.2 Error的种类</h3> <ul><li>InternalError:  创建一个代表Javascript引擎内部错误的异常抛出的实例。 如: &quot;递归太多&quot;。非ECMAScript标准。</li> <li>RangeError: 数值变量或参数超出其有效范围。例子：var a = new Array(-1);</li> <li>EvalError: 与eval()相关的错误。eval()本身没有正确执行。</li> <li>ReferenceError: 引用错误。 例子：console.log(b);</li> <li>SyntaxError: 语法错误。例子：var a = ;</li> <li>TypeError: 变量或参数不属于有效范围。例子：[1,2].split('.')</li> <li>URIError:  给 encodeURI或 decodeURl()传递的参数无效。例子：decodeURI('%2')</li></ul> <h2 id="_10-es6-新特性"><a href="#_10-es6-新特性" class="header-anchor">#</a> 10. ES6 新特性</h2> <h3 id="_10-1-let-const"><a href="#_10-1-let-const" class="header-anchor">#</a> 10.1 let &amp; const</h3> <h3 id="_10-2-模板字符串"><a href="#_10-2-模板字符串" class="header-anchor">#</a> 10.2 模板字符串</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// bad</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token string">'this is a'</span> <span class="token operator">+</span> example<span class="token punctuation">;</span>

<span class="token comment">// good</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this is a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>example<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">let</span> url <span class="token operator">=</span> oneLine <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    www.taobao.com/example/index.html
    ?foo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>foo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    &amp;bar=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bar<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-3-箭头函数"><a href="#_10-3-箭头函数" class="header-anchor">#</a> 10.3 箭头函数</h3> <p>箭头函数没有函数作用域，以下情况避免使用箭头函数：</p> <ul><li><p>定义对象的方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// bad</span>
<span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getValue</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

foo<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// undefined</span>
</code></pre></div></li> <li><p>定义原型方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// bad</span>
<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>

<span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
foo<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// undefined</span>
</code></pre></div></li> <li><p>作为事件的回调函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// bad</span>
<span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myButton'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Clicked button'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h3 id="_10-4-新数据类型"><a href="#_10-4-新数据类型" class="header-anchor">#</a> 10.4 新数据类型</h3> <ul><li>WeakSet
<ul><li>元素只能是Object类型，不能是其他类型的值。</li> <li>弱引用，即垃圾回收机制不考虑 WeakSet 对该对象的引用，也就是说，如果该对象不在被其他变量引用，那么垃圾回收机制就会自动回收该对象所占用内存，所以只要 WeakSet 成员对象在外部消失，它们在 WeakSet 里面的引用就会自动消失。</li> <li>由于 WeakSet 内部有多少个成员，取决于垃圾回收机制有没有运行，运行前后很可能成员个数是不一样的，而垃圾回收机制何时运行是不可预测的，因此 ES6 规定 WeakSet 不可遍历。</li></ul></li> <li>WeakMap
<ul><li>同 WeakMap</li></ul></li> <li>symbol
<ul><li>唯一 <code>const s = Symbol();</code></li> <li>应用场景：
<ul><li>消除魔法字符串</li> <li>作为对象属性，防止属性名被覆盖</li> <li>模拟类的私有方法</li></ul></li></ul></li></ul> <h4 id="_10-4-1-唯一值"><a href="#_10-4-1-唯一值" class="header-anchor">#</a> 10.4.1 唯一值</h4> <p>一个symbol值能作为对象属性的标识符；这是该数据类型仅有的目的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> symbol1 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> symbol2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> symbol3 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> symbol1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// expected output: &quot;symbol&quot;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>symbol2 <span class="token operator">===</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// expected output: false</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>symbol3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// expected output: &quot;Symbol(foo)&quot;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// expected output: false</span>

<span class="token comment">// 用法</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
person<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;range&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// range</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// undefined</span>
</code></pre></div><h4 id="_10-4-2-共享值"><a href="#_10-4-2-共享值" class="header-anchor">#</a> 10.4.2 共享值</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// &quot;uid&quot;</span>

<span class="token keyword">let</span> uid2 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>uid2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// &quot;uid&quot;</span>

<span class="token keyword">let</span> uid3 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>uid3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// undefined</span>
</code></pre></div><h4 id="_10-4-2-不可强制转换类型"><a href="#_10-4-2-不可强制转换类型" class="header-anchor">#</a> 10.4.2 不可强制转换类型</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'uid'</span><span class="token punctuation">)</span>
uid <span class="token operator">+</span> <span class="token string">''</span> <span class="token comment">// Uncaught TypeError: Cannot convert a Symbol value to a string</span>
</code></pre></div><h3 id="_10-5-set-和-map"><a href="#_10-5-set-和-map" class="header-anchor">#</a> 10.5 Set 和 Map</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 数组去重</span>

<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="_10-6-for-of"><a href="#_10-6-for-of" class="header-anchor">#</a> 10.6 for of</h3> <p>可以遍历的对象：</p> <ul><li>数组</li> <li>Set</li> <li>Map</li> <li>类数组（可以通过索引属性访问元素并且拥有 length 属性的对象。）</li> <li>Generator</li> <li>字符串</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> v <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-7-promise"><a href="#_10-7-promise" class="header-anchor">#</a> 10.7 Promise</h3> <h3 id="_10-8-class"><a href="#_10-8-class" class="header-anchor">#</a> 10.8 Class</h3> <h3 id="_10-9-拓展运算符"><a href="#_10-9-拓展运算符" class="header-anchor">#</a> 10.9 拓展运算符</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">sortNumbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// &lt;=&gt;</span>
<span class="token keyword">const</span> <span class="token function-variable function">sortNumbers</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>numbers</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> numbers<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// &lt;=&gt;</span>
Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">...</span>arr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-10-解构赋值"><a href="#_10-10-解构赋值" class="header-anchor">#</a> 10.10 解构赋值</h3> <h3 id="_10-11-对象属性简写（属性增强）"><a href="#_10-11-对象属性简写（属性增强）" class="header-anchor">#</a> 10.11 对象属性简写（属性增强）</h3> <h2 id="_11-async-await"><a href="#_11-async-await" class="header-anchor">#</a> 11. Async / Await</h2> <h3 id="_11-1-基本语法"><a href="#_11-1-基本语法" class="header-anchor">#</a> 11.1 基本语法</h3> <h4 id="_11-1-1-async函数返回一个promise对象"><a href="#_11-1-1-async函数返回一个promise对象" class="header-anchor">#</a> 11.1.1 <code>async</code>函数返回一个<code>Promise</code>对象</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;Hey,Range!&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hey,Range!</span>
</code></pre></div><h4 id="_11-1-2-如果-async-函数内部抛出异常，则会导致返回的-promise-对象状态变为-reject-状态。抛出的错误而会被-catch-方法回调函数接收到。"><a href="#_11-1-2-如果-async-函数内部抛出异常，则会导致返回的-promise-对象状态变为-reject-状态。抛出的错误而会被-catch-方法回调函数接收到。" class="header-anchor">#</a> 11.1.2 如果 <code>async</code> 函数内部抛出异常，则会导致返回的 Promise 对象状态变为 <code>reject</code> 状态。抛出的错误而会被 <code>catch</code> 方法回调函数接收到。</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_11-1-3-async函数内部return返回的值，会成为then方法回调函数的参数。"><a href="#_11-1-3-async函数内部return返回的值，会成为then方法回调函数的参数。" class="header-anchor">#</a> 11.1.3 <code>async</code>函数内部<code>return</code>返回的值，会成为<code>then</code>方法回调函数的参数。</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 也就是说，只有当 `async` 函数内部的异步操作都执行完，才会执行 `then` 方法的回调。</span>
<span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token parameter">timeout</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'done'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待6s后才输出 'done'</span>
</code></pre></div><h3 id="_11-2-错误处理"><a href="#_11-2-错误处理" class="header-anchor">#</a> 11.2 错误处理</h3> <h4 id="_11-2-1-当-async-函数中只要一个-await-出现-reject-状态，则后面的-await-都不会被执行。"><a href="#_11-2-1-当-async-函数中只要一个-await-出现-reject-状态，则后面的-await-都不会被执行。" class="header-anchor">#</a> 11.2.1 当 <code>async</code> 函数中只要一个 <code>await</code> 出现 reject 状态，则后面的 <code>await</code> 都不会被执行。</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> a<span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 这段 await 并没有执行</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
</code></pre></div><h4 id="_11-2-2-使用try-catch"><a href="#_11-2-2-使用try-catch" class="header-anchor">#</a> 11.2.2 使用<code>try/catch</code></h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> a<span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  a <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// error</span>
<span class="token comment">// 1</span>
</code></pre></div><h3 id="_11-3-在项目中使用async"><a href="#_11-3-在项目中使用async" class="header-anchor">#</a> 11.3 在项目中使用<code>async</code></h3> <ul><li><p>安装依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> babel-preset-es2015 babel-preset-stage-3 babel-runtime babel-plugin-transform-runtime
</code></pre></div></li> <li><p>修改<code>.babelrc.</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;es2015&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stage-3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;transform-runtime&quot;</span><span class="token punctuation">]</span>
</code></pre></div></li></ul> <h2 id="_12-fetch"><a href="#_12-fetch" class="header-anchor">#</a> 12. fetch</h2> <h3 id="_12-1-概念"><a href="#_12-1-概念" class="header-anchor">#</a> 12.1 概念</h3> <ul><li>Fetch本质上是一种标准，该标准定义了请求、响应和绑定的流程。Fetch标准还定义了Fetch () JavaScript API，它在相当低的抽象级别上公开了大部分网络功能。</li> <li>Fetch API 提供了一个获取资源的接口（包括跨域），它类似于 XMLHttpRequest ，但新的API提供了更强大和灵活的功能集。 <strong>Fetch 的核心在于对 HTTP 接口的抽象</strong>，包括 Request，Response，Headers，Body，以及用于初始化异步请求的 global fetch。</li> <li>Fetch API 提供了一种全局**<code>fetch()</code>**方法，它返回一个 promise，这个 promise 会在请求响应后被 resolve，并传回 Response 对象。</li></ul> <h3 id="_12-2-特点"><a href="#_12-2-特点" class="header-anchor">#</a> 12.2 特点</h3> <ul><li>当接收到一个代表错误的 HTTP 状态码时，从 <code>fetch()</code> 返回的 Promise <strong>不会被标记为 reject，</strong> 即使响应的 HTTP 状态码是 404 或 500。相反，它会将 Promise 状态标记为 resolve （但是会将 resolve 的返回值的 <code>ok</code> 属性设置为 false ），仅当网络故障时或请求被阻止时，才会标记为 reject。</li> <li><code>fetch()</code> <strong>可以接受跨域 cookie</strong>；你可以使用 <code>fetch()</code> 建立起跨域会话。</li> <li><code>fetch()</code> <strong>默认不会发送 cookie</strong>。除非你使用了<em>credentials</em> 的初始化选项。（自 2017 年 8 月 25 日以后，默认的 credentials 政策变更为 <code>same-origin</code>。Firefox 也在 61.0b13 版本中进行了修改）</li> <li>不支持超时控制</li> <li>由于fetch是比较底层的API，所以需要我们手动将参数拼接成<code>name=test</code>的格式，而jquery ajax已经封装好了。所以<code>fetch</code>并不是开箱即用的。</li></ul> <h3 id="_12-3-举例"><a href="#_12-3-举例" class="header-anchor">#</a> 12.3 举例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://example.com/movies.json'</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">myJson</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_13-pwa（progressive-web-apps，渐进式网络应用程序）"><a href="#_13-pwa（progressive-web-apps，渐进式网络应用程序）" class="header-anchor">#</a> 13. PWA（Progressive Web Apps，渐进式网络应用程序）</h2> <h3 id="_13-1-概念"><a href="#_13-1-概念" class="header-anchor">#</a> 13.1 概念</h3> <p>PWA相对于传统Web应用，主要在以下几个方面变得更强：</p> <ul><li>观感方面：在手机上，可以添加Web应用到桌面，并可提供类似于Native应用的沉浸式体验（也就是可以隐藏浏览器的脑门）。这部分背后的技术是manifest。</li> <li>性能方面：由于本文主角Service Worker具有拦截浏览器HTTP请求的超能力，搭配CacheStorage，PWA可以提升Web应用在网络条件不佳甚至离线时的用户体验和性能。</li> <li>其它方面：推送通知、后台同步等可选的高级功能，这些功能也是利用<strong>Service Worker</strong>来实现的。</li></ul> <p>简单一点说：</p> <ul><li>我们一般写 web 应用，在 pc 上是没有缓存的，打开页面的时去请求数据。（通过CacheStorage实现）</li> <li>没有像 app 一样的小图标放在桌面，一点开就进入了应用，而是通过打开浏览器输入网址。（通过manifest.json实现）</li> <li>不能像 app 一样给用户推送消息，像微博会跟你推送说有谁评论了你的微博之类的功能。（ServiceWorker实现）</li></ul> <h3 id="_13-2-service-worker"><a href="#_13-2-service-worker" class="header-anchor">#</a> 13.2 service worker</h3> <h4 id="_13-2-1-简介"><a href="#_13-2-1-简介" class="header-anchor">#</a> 13.2.1 简介</h4> <ul><li><code>Service Worker</code>是浏览器在后台独立于网页运行的、用JavaScript编写的脚本。</li> <li>本质上充当Web应用程序与浏览器之间的代理服务器，也可以在网络可用时作为浏览器和网络间的代理。</li> <li>它们旨在（除其他之外）使得能够创建有效的离线体验，拦截网络请求并基于网络是否可用以及更新的资源是否驻留在服务器上来采取适当的动作。他们还允许访问推送通知和后台同步<code>API</code>。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 不起眼的一行if，除了防止报错之外，也无意间解释了PWA的P：</span>
<span class="token comment">// 如果浏览器不支持Service Worker，那就当什么都没有发生过</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 所以Service Worker只是一个挂在navigator对象上的HTML5 API而已</span>
        navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我注册成功了666'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我注册失败了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以下代码，可以拦截网页上所有png图片的请求，返回你的支付宝收款码图片，只要用户够多，总会有人给你打钱的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// service-worker.js</span>
<span class="token comment">// 虽然可以在里边为所欲为地写任何js代码，或者也可以什么都不写，</span>
<span class="token comment">// 都不妨碍这是一个Service Worker，但还是举一个微小的例子：</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\.png$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/images/支付宝收款码.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_13-2-2-生命周期"><a href="#_13-2-2-生命周期" class="header-anchor">#</a> 13.2.2 生命周期</h4> <p>Service Worker生命周期：安装中、安装后、激活中、激活后、已卸载。</p> <ul><li>首次导航到网站时，会下载、解析并执行Service Worker文件，触发install事件，尝试安装Service Worker。</li> <li>如果install事件回调函数中的操作都执行成功，标志Service Worker安装成功，此时进入waiting状态。注意这时的Service Worker只是准备好了而已，并没有生效。</li> <li>当用户二次进入网站时，才会激活Service Worker，此时会触发activate事件，标志Service Worker正式启动，开始响应fetch、post、sync等事件。</li></ul> <h4 id="_13-2-3-主要事件"><a href="#_13-2-3-主要事件" class="header-anchor">#</a> 13.2.3 主要事件</h4> <ul><li>install：Service Worker安装时触发，通常在这个时机缓存文件。</li> <li>activate：Service Worker激活时触发，通常在这个时机做一些重置的操作，例如处理旧版本Service Worker的缓存。</li> <li>fetch：浏览器发起HTTP请求时触发，通常在这个事件的回调函数中匹配缓存，是最常用的事件。</li> <li>push：和推送通知功能相关。</li> <li>sync：和后台同步功能相关。</li></ul> <h4 id="_13-2-4-应用"><a href="#_13-2-4-应用" class="header-anchor">#</a> 13.2.4 应用</h4> <ul><li>缓存静态资源：可以利用CacheStorage API来缓存js、css、字体、图片等静态文件。</li> <li>离线体验：如果我们首页index.html缓存下来，那我们的网页甚至可以支持离线浏览。</li> <li>消息推送</li></ul> <h2 id="_14-防抖和节流"><a href="#_14-防抖和节流" class="header-anchor">#</a> 14. 防抖和节流</h2> <h3 id="_14-1-防抖"><a href="#_14-1-防抖" class="header-anchor">#</a> 14.1 防抖</h3> <h4 id="_14-1-1-概念"><a href="#_14-1-1-概念" class="header-anchor">#</a> 14.1.1 概念</h4> <p>触发事件后 n 秒后才执行函数，如果在 n 秒内又触发了事件，则会重新计算函数执行时间。</p> <h4 id="_14-1-2-例子"><a href="#_14-1-2-例子" class="header-anchor">#</a> 14.1.2 例子</h4> <div class="language-html extra-class"><pre class="language-html"><code>// 无防抖

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name">
    <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">height</span><span class="token punctuation">:</span>150px<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>150px<span class="token punctuation">;</span><span class="token property">text-align</span><span class="token punctuation">:</span>center<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span><span class="token property">background-color</span><span class="token punctuation">:</span>#ccc<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>80px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> num<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    content<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> count<span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 非立即执行</span>
<span class="token comment">// 触发事件后函数不会立即执行，而是在 n 秒后执行，如果在 n 秒内又触发了事件，则会重新计算函数执行时间。</span>

<span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// html中修改</span>
content<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 立即执行</span>
<span class="token comment">// 触发事件后函数会立即执行，然后 n 秒内不触发事件才能继续执行函数的效果。</span>
<span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> callNow <span class="token operator">=</span> <span class="token operator">!</span>timeout<span class="token punctuation">;</span>
    timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callNow<span class="token punctuation">)</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

content<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_14-1-3-应用场景"><a href="#_14-1-3-应用场景" class="header-anchor">#</a> 14.1.3 应用场景</h4> <ol><li>Google搜索的输入框</li> <li>Scroll滚动的时候检查位置（坐标）</li> <li>函数防抖就是法师丢技能的时候要读条，技能读条没完再按技能就会重新读条。</li></ol> <h3 id="_14-2-节流"><a href="#_14-2-节流" class="header-anchor">#</a> 14.2 节流</h3> <h4 id="_14-2-1-概念"><a href="#_14-2-1-概念" class="header-anchor">#</a> 14.2.1 概念</h4> <ul><li>所谓节流，就是指连续触发事件但是在 n 秒中只执行一次函数。</li> <li>区别于防抖：
<ul><li>立即/非立即执行的防抖函数，每次触发事件都会刷新定时器</li> <li>节流是只有事件真正执行的时候才会刷新定时器，保证某一时段内只执行一次函数。</li></ul></li></ul> <h4 id="_14-2-2-例子"><a href="#_14-2-2-例子" class="header-anchor">#</a> 14.2.2 例子</h4> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 时间戳 实现</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pre <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> pre <span class="token operator">&gt;</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      pre <span class="token operator">=</span> now<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定时器 实现</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_14-2-3-应用场景"><a href="#_14-2-3-应用场景" class="header-anchor">#</a> 14.2.3 应用场景</h4> <ol><li>监听滚动事件，比如是否滑到底部自动加载更多</li> <li>leetcode代码提交按钮</li> <li>函数节流就是fps游戏的射速，就算一直按着鼠标射击，也只会在规定射速内射出子弹。</li></ol> <h2 id="_15-js阻塞dom的解析"><a href="#_15-js阻塞dom的解析" class="header-anchor">#</a> 15. JS阻塞DOM的解析</h2> <h3 id="_15-1-ui渲染线程-与-js引擎-互斥"><a href="#_15-1-ui渲染线程-与-js引擎-互斥" class="header-anchor">#</a> 15.1 UI渲染线程 与 JS引擎 互斥</h3> <ul><li>当浏览器在解析 HTML 页面时遇到了 <code>&lt;script&gt;...&lt;/script&gt;</code> 标签，将无法继续构建DOM树，必须立即执行脚本。
<ul><li>原因：UI 渲染线程与 JS 引擎是互斥的，当 JS 引擎执行时 UI 线程会被挂起。（所以 <code>DOMContentLoaded</code> 有可能在所有脚本执行完毕后触发。）</li></ul></li> <li>外部样式表并不会阻塞 DOM 的解析，但是如果在样式后面有一个内联脚本，那么脚本必须等待样式先加载完：
<ul><li>原因：JS 因为有可能会去获取 DOM 的样式，所以 JS 会等待样式表加载完毕，而 JS 是阻塞 DOM 的解析的，所以在有外部样式表的时候，JS 会一直阻塞到外部样式表下载完毕</li></ul></li></ul> <h3 id="_15-2-async和defer"><a href="#_15-2-async和defer" class="header-anchor">#</a> 15.2 async和defer</h3> <ul><li>相同点：
<ul><li><code>async</code> 和 <code>defer</code> 属性仅仅对外部脚本起作用，并且他们在 <code>src</code> 不存在时会被自动忽略。</li> <li>带有 <code>async</code> 和 <code>defer</code> 的脚本的下载是和 HTML 的下载与解析是并行的，但是 JS 的执行一定是和 UI 线程是互斥的</li></ul></li> <li>不同点：
<ul><li>带有 <code>async</code> 的脚本是优先执行先加载完的脚本，他们在页面中的顺序并不影响他们执行的顺序。</li> <li>带有 <code>defer</code> 的脚本会在页面加载和解析完毕后执行，刚好在 <code>DOMContentLoaded</code> <strong>之前</strong>执行。</li></ul></li> <li>结论：
<ul><li>defer 和 async 在网络读取（下载）这块儿是一样的,都是异步的（相较于 HTML 解析）</li> <li>它俩的差别在于脚本下载完之后何时执行,显然 defer 是最接近我们对于应用脚本加载和执行的要求的</li> <li>关于 defer,此图未尽之处在于它是按照加载顺序执行脚本的,这一点要善加利用</li> <li>async 则是一个乱序执行的主,反正对它来说脚本的加载和执行是紧紧挨着的,所以不管你声明的顺序如何,只要它加载完了就会立刻执行</li> <li>仔细想想,async 对于应用脚本的用处不大,因为它完全不考虑依赖（哪怕是最低级的顺序执行）,不过它对于那些可以不依赖任何脚本或不被任何脚本依赖的脚本来说却是非常合适的</li></ul></li></ul> <h3 id="_15-3-js加载时间线"><a href="#_15-3-js加载时间线" class="header-anchor">#</a> 15.3 js加载时间线</h3> <ol><li>创建Document对象，开始解析web页面。解析HTML元素和他们的文本内容后添加Element对象和Text节点到文档中。这个阶段document.readyState= <strong>'loading</strong>'。</li> <li>遇到link外部css，创建线程加载，并继续解析文档。</li> <li>遇到script外部js，并且没有设置async、defer，<strong>浏览器加载，并阻塞，等待js加载完成并执行该脚本，然后继续解析文档</strong>。</li> <li>遇到script外部js，并且设置有async、defer，浏览器创建线程加载，并继续解析文档。<strong>对于async属性的脚本，脚本加载完成后立即执行</strong>。（ <strong>异步禁止使用document.write()</strong>,因为这个方法会将之前所有的文档流消除 ）</li> <li>遇到img等，先正常解析dom结构，然后<strong>浏览器异步加载src</strong>，并继续解析文档。</li> <li>当文档解析完成（domTree加载完），document.readyState =<strong>'interactive'</strong>。</li> <li>文档解析完成后，<strong>所有设置有defer的脚本会按照顺序执行</strong>。（注意与async的不同,但同样禁止使用document.write()）;</li> <li>document对象触发 <strong>DOMContentLoaded</strong> 事件，这也标志着程序执行从同步脚本执行阶段，转化为事件驱动阶段。</li> <li>当所有async的脚本加载完成并执行后、img等加载完成后，document.readyState= <strong>'complete</strong>'，<strong>window对象触发load事件</strong>。</li> <li>从此，以异步响应方式处理用户输入、网络事件等。</li></ol> <p><strong>注意：</strong> DOMContentLoaded 事件只能用 addEventListener 进行绑定；如果希望script是在domTree加载完（img等还没加载）就立马执行，可以将 script 写在 head 标签里面；这种写法比 window.onload 事件快，因为load事件是让 script 在img等加载完之后再执行；当然，通用的写法还是将 script 写在 body 标签的最下面</p> <h2 id="_16-深拷贝与浅拷贝"><a href="#_16-深拷贝与浅拷贝" class="header-anchor">#</a> 16 深拷贝与浅拷贝</h2> <h3 id="_16-1-浅拷贝"><a href="#_16-1-浅拷贝" class="header-anchor">#</a> 16.1 浅拷贝</h3> <ul><li><code>Object.assign()</code></li> <li>函数库lodash的<code>_.clone</code>方法</li> <li>展开运算符<code>...</code></li> <li><code>Array.prototype.concat()</code></li> <li><code>Array.prototype.slice()</code></li></ul> <h3 id="_16-2-深拷贝"><a href="#_16-2-深拷贝" class="header-anchor">#</a> 16.2 深拷贝</h3> <ul><li><code>JSON.parse(JSON.stringify())</code></li> <li>函数库lodash的<code>_.cloneDeep</code>方法</li> <li><code>.jQuery.extend()</code></li></ul> <h2 id="_17-前端模块化"><a href="#_17-前端模块化" class="header-anchor">#</a> 17. 前端模块化</h2> <h3 id="_17-1-commonjs"><a href="#_17-1-commonjs" class="header-anchor">#</a> 17.1 CommonJS</h3> <ul><li><p>特点</p> <ul><li>CommonJS 模块输出的是一个值的拷贝（引用类型是浅拷贝）</li> <li>CommonJS 模块是 Node.js 专用的（在服务端，模块文件都存在本地磁盘，支持同步的方式执行；但是在浏览器端，由于网络的原因，更优的方式是异步加载），与 ES6 模块不兼容。</li> <li>CommonJS 的<code>require()</code>命令不能加载 ES6 模块，会报错。<code>require()</code>不支持 ES6 模块的一个原因是，它是同步加载，而 ES6 模块内部可以使用顶层<code>await</code>命令，导致无法被同步加载。</li> <li>所有代码都运行在模块作用域，不会污染全局作用域。</li> <li>模块加载的顺序，按照其在代码中出现的顺序。</li></ul></li> <li><p>加载机制</p> <ul><li>CommonJS 模块是运行时加载。</li> <li>CommonJS 的一个模块，就是一个脚本文件。<code>require</code>命令第一次加载该脚本，就会执行整个脚本，然后在内存生成一个对象。</li> <li>CommonJS 模块是对象，整体加载某个模块（即加载该模块的所有方法），生成一个对象，然后再从这个对象上面读取 该对象所拥有的方法。</li> <li>CommonJS 模块无论加载多少次，都只会在第一次加载时运行一次，以后再加载，就返回第一次运行的结果，除非手动清除系统缓存。</li></ul></li> <li><p>基本语法</p> <ul><li><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 暴露模块</span>
<span class="token comment">// example.js</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">addX</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> value <span class="token operator">+</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>addX <span class="token operator">=</span> addX<span class="token punctuation">;</span>

<span class="token comment">// 引入</span>
<span class="token keyword">var</span> example <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果参数字符串以“./”开头，则表示加载的是一个位于相对路径</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">addX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>
</code></pre></div></li></ul></li></ul> <h3 id="_17-2-amd"><a href="#_17-2-amd" class="header-anchor">#</a> 17.2 AMD</h3> <ul><li><p>特点</p> <ul><li>AMD规范则是非同步加载模块，允许指定回调函数。</li> <li>如果是浏览器环境，要从服务器端加载模块，这时就必须采用非同步模式，因此浏览器端一般采用AMD规范。此外AMD规范比CommonJS规范在浏览器端实现要来着早。</li></ul></li> <li><p>基本语法</p> <ul><li><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 暴露模块</span>
<span class="token comment">//定义没有依赖的模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> 模块
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//定义有依赖的模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'module1'</span><span class="token punctuation">,</span> <span class="token string">'module2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> 模块
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 引入模块</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'module1'</span><span class="token punctuation">,</span> <span class="token string">'module2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   使用m1<span class="token operator">/</span>m2
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul> <h3 id="_17-3-cmd"><a href="#_17-3-cmd" class="header-anchor">#</a> 17.3 CMD</h3> <ul><li><p>特点</p> <ul><li>CMD规范专门用于浏览器端，模块的加载是异步的，模块使用时才会加载执行。CMD规范整合了CommonJS和AMD规范的特点。</li></ul></li> <li><p>基本语法</p> <ul><li><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 暴露模块</span>
<span class="token comment">//定义没有依赖的模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span>xxx <span class="token operator">=</span> value
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> value
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//定义有依赖的模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//引入依赖模块(同步)</span>
  <span class="token keyword">var</span> module2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module2'</span><span class="token punctuation">)</span>
  <span class="token comment">//引入依赖模块(异步)</span>
    require<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">'./module3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//暴露模块</span>
  exports<span class="token punctuation">.</span>xxx <span class="token operator">=</span> value
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 引入模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> m1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module1'</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module4'</span><span class="token punctuation">)</span>
  m1<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  m4<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul> <h3 id="_17-4-es-module"><a href="#_17-4-es-module" class="header-anchor">#</a> 17.4 ES Module</h3> <ul><li><p>特点</p> <ul><li>ES6 模块输出的是值的引用。</li> <li>ES6 模块的<code>import</code>命令可以加载 CommonJS 模块，但是只能整体加载，不能只加载单一的输出项（即解构赋值的形式）。</li></ul></li> <li><p>加载机制</p> <ul><li>ES6 模块是编译时输出接口。</li> <li>ES6 可以在编译时就完成模块加载，效率要比 CommonJS 模块的加载方式高。当然，这也导致了没法引用 ES6 模块本身，因为它不是对象。</li> <li>JS 引擎对脚本静态分析的时候，遇到模块加载命令<code>import</code>，就会生成一个只读引用。等到脚本真正执行时，再根据这个只读引用，到被加载的那个模块里面去取值。</li></ul></li> <li><p>基本语法</p> <ul><li><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 暴露模块</span>
<span class="token comment">// math.js</span>
<span class="token keyword">var</span> basicNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> basicNum<span class="token punctuation">,</span> add <span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 引入模块</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> basicNum<span class="token punctuation">,</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./math'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ele<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">99</span> <span class="token operator">+</span> basicNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>package.json</p> <ul><li>type =&gt; module(ESM) / commonjs(CJS)
<ul><li>.mjs总是以ESM模块加载</li> <li>.cjs总是CJS模块加载</li> <li>详情参见https://nodejs.org/api/packages.html#packages_type</li></ul></li></ul></li> <li><p>Tips</p> <ul><li><code>exports</code> 和 <code>module.exports</code> 的关系
<ul><li><code>exports</code> 是 <code>module.exports</code> 的一个引用</li> <li>即 <code>exports = module.exports = {}</code></li></ul></li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/css/" class="prev">
        CSS
      </a></span> <span class="next"><a href="/interviews/">
        Interviews
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.76b04930.js" defer></script><script src="/assets/js/2.f4607b1e.js" defer></script><script src="/assets/js/12.cb6c9e06.js" defer></script>
  </body>
</html>
